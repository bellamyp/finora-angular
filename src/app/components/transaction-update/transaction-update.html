<div class="container py-5">
  <h2 class="text-center mb-4 fw-bold text-primary">{{ pageTitle }}</h2>

  <!-- Loading UI -->
  <div *ngIf="loading" class="text-center text-muted fs-5">
    <i class="bi bi-hourglass-split fs-2"></i>
    <div>Loading transaction group...</div>
  </div>

  <!-- No transactions UI -->
  <div *ngIf="!loading && transactions.length === 0" class="text-center text-muted fs-5">
    <i class="bi bi-clock-history fs-2"></i>
    <div>No transactions found in this group.</div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle shadow-sm rounded-4 bg-white edit-transactions-table">
      <thead class="table-light text-center">
      <tr>
        <th style="width:12%;">Date</th>
        <th style="width:12%;">Type</th>
        <th style="width:12%;">Brand</th>
        <th style="width:12%;">Location</th>
        <th style="width:12%;">Amount</th>
        <th style="width:30%;">Notes</th>
        <th style="width:15%;">Bank</th>
        <th style="width:14%;">Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let tx of transactions; let i = index" [ngClass]="{'posted': tx.posted}">
        <td><input type="date" class="form-control" [(ngModel)]="tx.date" name="date{{i}}" [disabled]="tx.posted"></td>

        <td>
          <select class="form-select" [(ngModel)]="tx.typeId" name="type{{i}}" [disabled]="tx.posted">
            <option value="">-- Type --</option>
            <option *ngFor="let t of transactionTypes" [value]="t.id">{{ t.name }}</option>
          </select>
        </td>

        <td>
          <select class="form-select" [(ngModel)]="tx.brandId" name="brand{{i}}" [disabled]="tx.posted">
            <option value="">-- Brand --</option>
            <option *ngFor="let b of brands" [value]="b.id">{{ b.name }}</option>
          </select>
        </td>

        <td>
          <select class="form-select" [(ngModel)]="tx.locationId" name="location{{i}}" [disabled]="tx.posted">
            <option value="">-- Location --</option>
            <option *ngFor="let loc of locations" [value]="loc.id">{{ loc.name }}</option>
          </select>
        </td>

        <td><input type="number" class="form-control" [(ngModel)]="tx.amount" name="amount{{i}}" step="0.01" [disabled]="tx.posted"></td>

        <td><input type="text" class="form-control" [(ngModel)]="tx.notes" name="notes{{i}}" [disabled]="tx.posted"></td>

        <td>
          <select class="form-select" [(ngModel)]="tx.bankId" name="bank{{i}}" [disabled]="tx.posted">
            <option value="">-- Bank --</option>
            <option *ngFor="let b of banks" [value]="b.id">{{ b.name }}</option>
          </select>
        </td>

        <td class="text-center">
          <div class="d-flex justify-content-center gap-1 flex-wrap">
            <button type="button" class="btn btn-sm btn-primary"
                    (click)="markAsPosted(tx)"
                    [disabled]="tx.posted || mode !== 'update'">
              Posted
            </button>
            <button type="button" class="btn btn-sm btn-danger" (click)="deleteTransaction(tx, i)" [disabled]="tx.posted">Delete</button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Bottom actions -->
  <div class="bottom-actions d-flex flex-wrap justify-content-between mt-4 p-3 shadow-sm rounded-4 bg-white gap-2">
    <div class="d-flex gap-2 flex-wrap align-items-center">
      <button type="button" class="btn btn-outline-primary" (click)="addTransaction()">+ Add Transaction</button>

      <!-- Dynamic Cashback Button & Input -->
      <div class="d-flex gap-1 align-items-center">
        <button type="button" class="btn btn-outline-success" (click)="showCashbackInput = true">Cashback %</button>

        <!-- Show input only when user clicks the button -->
        <div *ngIf="showCashbackInput" class="d-flex gap-1 align-items-center">
          <input type="number" class="form-control form-control-sm" [(ngModel)]="cashbackPercent"
                 placeholder="Enter %" step="0.1" min="0.1" max="100" style="width: 80px;">
          <button type="button" class="btn btn-success btn-sm" (click)="addCashbackTransaction(cashbackPercent)">Add</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="showCashbackInput = false">Cancel</button>
        </div>
      </div>

      <button type="button" class="btn btn-outline-warning" (click)="openAddLocation()">Add Location</button>
      <button type="button" class="btn btn-outline-info" (click)="openAddBrand()">Add Brand</button>
      <button type="button" class="btn btn-outline-secondary" (click)="openAddBank()">Add Bank</button>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <button type="button" class="btn btn-primary" (click)="submitAll()">Submit</button>
      <button type="button" class="btn btn-secondary" (click)="cancel()">Reset</button>
      <button type="button" class="btn btn-outline-dark" (click)="goBack()">Pending Transactions</button>
    </div>
  </div>

</div>
